<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAG SYSTEM</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and base */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            color: #333;
            /*
            display: flex;
            justify-content: none;
            */
        }

        .container {
            max-width: 700px;
            width: 100%;
            background: #fff;
            border-radius: 10px;
            padding: 2rem 2rem 3rem;
            box-shadow: 0 8px 20px rgb(0 0 0 / 0.1);
        }

        textarea,
        select {
            width: 100%;
            padding: 0.7rem 1rem;
            border-radius: 6px;
            border: 1.8px solid #ddd;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }

        textarea:focus,
        select:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            padding: 0.7rem 1.2rem;
            width: 100%;
            background-color: #3498db;
            border: none;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover:not(:disabled) {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        button.submit {
            margin-top: 1.5rem;
            background: #3498db;
            color: white;
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        label {
            font-weight: bold;
            color: #555;
        }

        input[type="number"],
        textarea,
        select,
        input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            margin-top: 0.3rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .note {
            font-size: 0.85rem;
            color: #777;
        }

        textarea {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-sizing: border-box;
        }

        H3 {
            color: #0000FF;
            display: block;
            font-size: 1.17em;
            margin-block-start: 5px;
            margin-block-end: 5px;
            margin-inline-start: 0px;
            margin-inline-end: 5px;
            font-weight: bold;
            unicode-bidi: isolate;
        }

        #loader-overlay {
            position: fixed;
            top: 94%;
            right: 20px;
            width: auto;
            height: auto;
            background-color: rgba(0, 0, 0, 0.01);
            padding: 10px;
            border-radius: 8px;
            display: flex !important;
            flex-direction: row;
            /* 水平排列 */
            justify-content: center;
            align-items: center;
            z-index: 999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .loader {
            border: 6px solid rgba(179, 217, 217, 0.2);
            border-top: 6px solid #B3D9D9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 12px;
            /* 與文字間隔 */
            transition: transform 2s ease-out, opacity 2s ease-out;
            /* 加上 opacity 來做淡出淡入 */
        }

        .loader-text {
            font-size: 1.5em;
            /* h1 大小接近效果 */
            color: #B3D9D9;
            font-weight: bold;
            white-space: nowrap;
        }

        /* 持續旋轉動畫 */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 平滑停止的動畫 */
        @keyframes slow-stop {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 1.5rem 1rem 2rem;
            }

            button {
                font-size: 1rem;
                padding: 0.6rem 1rem;
            }
        }

        .tabs {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            background: #3498db;
            color: white;
            padding: 0;
        }

        /* 以下為本次新增TAB處理 */
        .tabs button {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .tabs button.active {
            background: #2980b9;
        }

        .tab-content {
            display: none;
            padding-top: 0em;
            padding-right: 0.2em;
            padding-bottom: 0.2em;
            padding-left: 0.2em;
            max-width: 800px;
            margin: auto;
            background: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        #qaTab {
            width: 100vw;
            max-width: 100vw;
            height: calc(100vh - 100px);
            box-sizing: border-box;
        }

        #actualprompt {
            border-radius: 8px;
            font-size: 0.9em;
            overflow-y: auto;
            background: #f4f4f4;
            border: 1px solid #ccc;
            padding: 1em;
            white-space: pre-wrap;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: none;
        }

        /*border: 1px solid #ccc;*/
        #thinkResponse {
            border-radius: 8px;
            padding: 0.5em;
            background: #f4f4f4;
            overflow-y: auto;
            flex-grow: 0;
            min-height: 0;
            scrollbar-width: none;
            box-sizing: border-box;
            max-height: 100px;
        }

        /*border: 1px solid #ccc;*/
        #nounAnalysis {
            border-radius: 8px;
            padding: 0.5em;
            background: #f4f4f4;
            overflow-y: auto;
            flex-grow: 0;
            min-height: 0;
            scrollbar-width: none;
            box-sizing: border-box;
            max-height: 100px;
        }

        /* white-space: pre-wrap; */
        #answer {
            flex: 1 1 0;
            overflow-y: auto;
            padding: 1rem 1.2rem;
            background-color: #eef6fc;
            border-radius: 8px;
            border: 1.5px solid #b3d4fc;
            min-height: 0;
            box-sizing: border-box;
            font-size: 1rem;
            color: #2c3e50;
            border: 1px solid #ccc;
            padding: 1em;
            background: #f4f4f4;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: none;
            box-sizing: border-box;
            line-height: 2.0;
        }

        /* Markdown style */
        #answer h1,
        #answer h2,
        #answer h3,
        #answer h4,
        #answer h5,
        #answer h6 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 700;
            color: #2c3e50;
        }

        #answer p {
            margin-bottom: 1em;
            line-height: 1.6;
            color: #333;
        }

        #answer a {
            color: #3498db;
            text-decoration: none;
        }

        #answer a:hover {
            text-decoration: underline;
        }

        #answer ul,
        #answer ol {
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        #answer blockquote {
            border-left: 4px solid #ccc;
            padding-left: 1em;
            color: #666;
            font-style: italic;
            background: #f9f9f9;
            margin: 1em 0;
        }

        #answer code {
            background: #eee;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Consolas, "Courier New", monospace;
            font-size: 0.95em;
        }

        #answer pre {
            background: #2d2d2d;
            color: #ccc;
            padding: 1em;
            overflow-x: auto;
            border-radius: 6px;
            margin-bottom: 1em;
            font-family: Consolas, "Courier New", monospace;
            font-size: 0.9em;
        }

        #answer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }

        #answer th,
        #answer td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: left;
        }

        #answer th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        #answer tr:nth-child(even) {
            background-color: #fafafa;
        }

        #answer::-webkit-scrollbar {
            width: 8px;
        }

        #answer::-webkit-scrollbar-thumb {
            background-color: #bbb;
            border-radius: 4px;
        }

        /* 調整索引與參數 TAB 按鈕高度為 80px，問答不變 */
        .tabs button:nth-child(3),
        .tabs button:nth-child(4),
        .tabs button:nth-child(5),
        .tabs button:nth-child(6) {
            min-width: 80px;
            max-width: 80px;
            padding-top: 0;
            padding-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .formparam-group {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .formparam-group label {
            min-width: 300px;
            max-width: 500px;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .formparam-group input,
        .formparam-group select {
            flex: 1;
            height: 2.4rem;
            /* 手動設定高度 */
            font-size: 1rem;
            padding: 0.4rem;
            box-sizing: border-box;
        }

        /* drawerContainer 預設收合 */
        #drawerContainer {
            width: 80px;
            background: #f9f9f9;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #drawerContainer.drawer-open {
            width: 300px;
        }

        #drawerToggleButtons {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            gap: 5px;
            background: #ffffff;
        }

        #drawerToggleButtons button {
            width: 100%;
            height: 40px;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        #drawerToggleButtons button:hover {
            background: #2980b9;
        }

        #drawerContent {
            flex-grow: 1;
            overflow-y: auto;
            padding: 5px;
        }

        /* 預設所有 panel 隱藏 */
        .drawer-panel {
            display: none;
        }

        .drawer-panel.active {
            display: block;
        }

        .active-conversation {
            background-color: #d0ebff;
            border-left: 4px solid #228be6;
            border-radius: 4px;
            font-weight: bold;
            padding-left: 5px;
        }

        .drawer-toggle-btn.active {
            background: #2f3d5e;
            color: #2980b9;
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loader {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(179, 217, 217, 0.2);
            border-top: 3px solid #B3D9D9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 8px;
            box-sizing: border-box;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 新增個人功能抽屜樣式 */
        .user-menu-drawer {
            position: fixed;
            top: 0;
            right: -300px;
            /* 初始位置在右側外 */
            width: 300px;
            height: calc(100vh - 5px);
            border-radius: 0 0 0 8px;
            background-color: rgba(0, 0, 0, 0.5);
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease-in-out;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .user-menu-drawer.open {
            right: 0;
            /* 打開時移到右側 */
        }

        .user-menu-header {
            /*Fdisplay: flex;*/
            justify-content: space-between;
            align-items: center;
            padding: 0px 20px;
            border-bottom: 1px solid #eee;
        }

        .user-menu-header .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #555;
            cursor: pointer;
        }

        .user-menu-content {
            padding: 20px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .menu-item:hover {
            background-color: #f0f0f0;
        }

        .menu-item i {
            margin-right: 10px;
            font-size: 1.1em;
        }

        .menu-item span {
            font-size: 1em;
        }

        .modal {
            display: none;
            /* 隱藏預設 */
            position: fixed;
            /* 固定定位 */
            z-index: 1002;
            /* 確保在其他內容之上 */
            left: 0;
            top: 0;
            width: 100%;
            /* 佔滿整個視窗 */
            height: 100%;
            /* 佔滿整個視窗 */
            overflow: auto;
            /* 允許滾動 */
            background-color: rgba(0, 0, 0, 0.4);
            /* 半透明背景 */
            padding-top: 60px;
            /* 避免內容被標題欄遮擋 */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            /* 15% 從頂部 */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            /* 佔視窗寬度的 80% */
            max-width: 400px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #555;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn-secondary:hover {
            background-color: #d0d0d0;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        /* 個人功能按鈕樣式 */
        #userMenuBtn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #userMenuBtn:hover {
            background-color: #2980b9;
        }

        /* 個人功能列表按鈕的字母 avatar */
        #userInitial {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #f0f0f0;
            color: #333;
            border-radius: 50%;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin: 0 2px;
            vertical-align: middle;
        }

        /* 美化 userMenuUsername */
        #userMenuUsername {
            display: block;
            font-size: 3.0em;
            font-weight: 600;
            color: #f0f0f0;
            letter-spacing: 0.5px;
            margin: 0px 0 8px 0;
            text-align: center;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <div class="tabs">
        <div id="loader-overlay">
            <div class="loader"></div>
            <div class="loader-text">系統處理中...</div>
        </div>
        <button class="tablink active" onclick="switchTab('qaTab')" title="問答"><i class="fa-solid fa-comments"></i></button>
        <button class="tablink" onclick="openUserMenu()" id="userMenuBtn"><span id="userInitial">U</span></button>
        <!--
        <button class="tablink" onclick="logout()" title="登出"><i class="fa-solid fa-door-open"></i></button>
        -->
    </div>

    <!-- 個人功能抽屜 -->
    <div id="userMenuDrawer" onclick="closeUserMenu()" class="user-menu-drawer">
        <div class="user-menu-header">
            <span id="userMenuUsername"></span>
        </div>
        <div class="user-menu-content">
            <button onclick="showChangePasswordModal()" class="menu-item">
                <i class="fa-solid fa-key"></i>
                <span>變更密碼</span>
            </button>
            <hr>
            <button onclick="logout()" class="menu-item">
                <i class="fa-solid fa-sign-out-alt"></i>
                <span>登出</span>
            </button>
        </div>
    </div>

    <!-- 變更密碼模態框 -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>變更密碼</h3>
                <i class="fa-solid fa-key"></i>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="oldPassword">舊密碼</label>
                    <input type="password" id="oldPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">新密碼</label>
                    <input type="password" id="newPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">確認新密碼</label>
                    <input type="password" id="confirmNewPassword" required minlength="6">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeChangePasswordModal()" class="btn-secondary">取消</button>
                <button onclick="changePassword()" class="btn-primary">確認變更</button>
            </div>
        </div>
    </div>

    <div id="qaTab" class="tab-content active">

        <div style="display: flex; gap: 0.1rem; height: calc(100% - 60px); overflow: hidden;">

            <!-- 左側抽屜容器 -->
            <div id="drawerContainer" class="drawer-closed">
                <!-- 抽屜頂端按鈕 -->
                <div id="drawerToggleButtons">
                    <!--
                    <button onclick="toggleDrawer()"><i class="fas fa-bars"></i></button>
                    -->
                    <button title="對話記憶" class="drawer-toggle-btn" onclick="showDrawerContent('memoryDrawer')"><i class="fa-solid fa-folder"></i></button>
                    <!--
                    <button title="系統提示" class="drawer-toggle-btn" onclick="showDrawerContent('promptDrawer')"><i class="fa-solid fa-terminal"></i></button>
                    -->
                </div>

                <!-- 抽屜內容 -->
                <div id="drawerContent">
                    <HR>
                    <!-- 對話記憶區 -->
                    <div id="memoryDrawer" class="drawer-panel">
                        <button title="新增對話" onclick="createNewConversation()"><i class="fas fa-solid fa-plus"></i></button>
                        <ul id="conversationList" style="list-style: none; padding: 0;"></ul>
                    </div>

                    <!-- Prompt 區 -->
                    <!--
                    <div id="promptDrawer" class="drawer-panel">
                        <button onclick="document.getElementById('actualprompt').innerText = '';" title="清除"><i class="fa-solid fa-eraser"></i></button>
                        <div id="actualprompt" style="white-space: pre-wrap;"></div>
                    </div>
                    -->
                </div>
            </div>

            <!-- 右側：問答區 -->
            <div id="qaContent" style="flex: 2; min-width: 400px; display: flex; flex-direction: column;">
                <div style="flex-grow: 1; display: flex; flex-direction: column; margin-top: 0px;">
                    <div style="display: flex; align-items: flex-start; margin: 5px;">
                        <i id="nounAnalysisToggleIcon" title="開啟名詞分析" onclick="toggleNounAnalysis()" class="fa-solid fa-toggle-off fa-2x" style="vertical-align:top;margin-right: 10px;color: #3498db;"></i>
                        <div id="nounAnalysis" aria-live="polite" aria-atomic="true" style="flex-grow: 1;">己關閉名詞分析</div>
                    </div>
                    <div id="thinkToggleSection" style="display: flex; align-items: flex-start; margin: 5px;">
                        <i id="thinkResponseToggleIcon" title="開啟推理功能" onclick="toggleThinkResponse()" class="fa-solid fa-toggle-off fa-2x" style="margin-right: 10px;color: #3498db;"></i>
                        <div id="thinkResponse" aria-live="polite" aria-atomic="true" style="flex-grow: 1;">己關閉推理</div>
                    </div>
                    <div id="answer" aria-live="polite" aria-atomic="true" style="
                      border: 1px solid #ccc;
                      padding: 1em;
                      background: #f4f4f4;
                      overflow-y: auto;
                      flex-grow: 1;
                      min-height: 0;
                      scrollbar-width: none;
                      box-sizing: border-box;
                     ">
                    </div>
                </div>
                <div style="flex: 0 0 auto;">
                    <textarea id="question" rows="3" placeholder="請輸入問題..." aria-required="true" style="width: 100%; resize: vertical;"></textarea>
                    <button type="button" id="sendBtn" style="margin-top: 10px;">送出問題</button>
                </div>
            </div>
        </div>
    </div>


    <!-- 引入 marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 抽屜切換、新對話建立、對話列表切換 -->
    <script>
        let fullAnswer = ""
        let conversations = {};
        let currentConvId = null;
        let userScrolled = false; // 追蹤用戶是否手動滾動

        //function toggleDrawer() {
        //    const container = document.getElementById("drawerContainer");
        //    container.classList.toggle("drawer-open");
        //     updateMemoryDrawerIcon();
        //}

        function updateMemoryDrawerIcon() {
            const drawer = document.getElementById('drawerContainer');
            const memoryBtn = document.querySelector('#drawerToggleButtons .drawer-toggle-btn[title="對話記憶"] i');
            const memoryPanel = document.getElementById('memoryDrawer');
            if (drawer.classList.contains('drawer-open') && memoryPanel.classList.contains('active')) {
                memoryBtn.className = 'fa-solid fa-folder-open';
            } else {
                memoryBtn.className = 'fa-solid fa-folder';
            }
        }

        function showDrawerContent(id) {
            const drawer = document.getElementById('drawerContainer');
            drawer.classList.toggle("drawer-open");
            // 先隱藏全部
            document.querySelectorAll(".drawer-panel").forEach(el => {
                el.classList.remove("active");
            });
            // 顯示指定
            document.getElementById(id).classList.add("active");

            // 確保抽屜展開
            //document.getElementById("drawerContainer").classList.add("drawer-open");

            // drawer-toggle-btn 高亮處理
            document.querySelectorAll("#drawerToggleButtons .drawer-toggle-btn").forEach(btn => {
                btn.classList.remove("active");
            });
            if (id === "memoryDrawer") {
                document.querySelector('#drawerToggleButtons .drawer-toggle-btn[title="對話記憶"]').classList.add("active");
            }
            // else if (id === "promptDrawer") {
            //    document.querySelector('#drawerToggleButtons .drawer-toggle-btn[title="系統提示"]').classList.add("active");
            //}
            updateMemoryDrawerIcon();
        }

        function createNewConversation() {
            const q = document.getElementById("question").value.trim();
            const title = q.slice(0, 10);
            const id = `conv-${Date.now()}`;
            fullAnswer = "";
            answerDiv.innerHTML = "";
            conversations[id] = { title: title, messages: [] };
            currentConvId = id;
            updateConversationList();
        }

        function updateConversationList() {
            const list = document.getElementById("conversationList");
            list.innerHTML = "";

            for (const [id, conv] of Object.entries(conversations)) {
                const li = document.createElement("li");
                li.dataset.convId = id;
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                li.style.alignItems = "center";
                li.style.marginBottom = "8px";

                const titleSpan = document.createElement("span");
                titleSpan.textContent = conv.title;
                titleSpan.style.cursor = "pointer";
                titleSpan.style.flex = "0 0 180px";   // 固定寬度
                titleSpan.style.fontSize = "clamp(10px, 2vw, 14px)";
                titleSpan.style.overflow = "hidden";
                titleSpan.style.textOverflow = "ellipsis";
                titleSpan.style.whiteSpace = "nowrap";
                titleSpan.onclick = () => switchConversation(id);

                const delBtn = document.createElement("button");
                delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                delBtn.onclick = () => deleteConversation(id);
                delBtn.style.marginLeft = "auto";

                li.appendChild(titleSpan);
                li.appendChild(delBtn);
                list.appendChild(li);
                // 若目前就是 active 的 conversation，就加上 active 樣式
                if (id === currentConvId) {
                    li.classList.add("active-conversation");
                }
            }
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function switchConversation(id) {
            currentConvId = id;

            // 移除全部 active
            document.querySelectorAll("#conversationList li").forEach(li => {
                li.classList.remove("active-conversation");
            });

            // 加到目前 active
            const activeLi = document.querySelector(`#conversationList li[data-conv-id='${id}']`);
            if (activeLi) {
                activeLi.classList.add("active-conversation");
            }

            const conv = conversations[id];

            const answerDiv = document.getElementById("answer");
            answerDiv.innerHTML = "";
            fullAnswer = "";
            conv.messages.forEach(item => {
                // 使用者問題
                const userBlock = document.createElement("div");
                userBlock.innerHTML = `<i class="fa-solid fa-user-minus"></i> ${item.q}`;
                userBlock.style.background = "#e8f0fe";
                userBlock.style.padding = "8px";
                userBlock.style.marginBottom = "10px";
                userBlock.style.textAlign = "right";

                // LLM 回答
                const answerHtml = marked.parse(item.a);
                const answerBlock = document.createElement("div");
                answerBlock.className = "markdown-body";
                answerBlock.innerHTML = answerHtml;
                answerBlock.style.background = "#f4f4f4";
                answerBlock.style.padding = "8px";
                answerBlock.style.marginBottom = "20px";
                answerDiv.appendChild(userBlock);
                answerDiv.appendChild(answerBlock);
                fullAnswer += answerHtml;
            });

            answerDiv.scrollTop = answerDiv.scrollHeight;
            document.getElementById("question").value = "";
        }

        async function deleteConversation(id) {
            delete conversations[id];
            if (currentConvId === id) {
                currentConvId = null;
                document.getElementById("question").value = "";
                document.getElementById("answer").innerHTML = "";
            }
            await fetch("/conversations/" + id, {
                method: "DELETE",
            });
            updateConversationList();
        }

        async function loadConversations() {
            const res = await fetch("/conversations");
            const list = await res.json();

            list.forEach(item => {
                conversations[item.id] = {
                    title: item.title,
                    messages: item.messages,
                };
            });
            updateConversationList();
        }

        const answerDiv = document.getElementById("answer");
        const questionInput = document.getElementById("question");
        const sendBtn = document.getElementById("sendBtn");
        //const actualpromptDiv = document.getElementById("actualprompt");
        const nounAnalysisDiv = document.getElementById("nounAnalysis");
        const thinkResponseDiv = document.getElementById("thinkResponse");
        const parserTitleStr = "分析問題名詞並生成同義詞中...";

        //支援 markdown table
        marked.setOptions({
            breaks: true,
            gfm: true,
        });
        function switchTab(tabId) {
            document.querySelectorAll('.tablink').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick*="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            checkThinkFeature();
        }

        /** Loader 處理 Start */
        function showSpinner(message = "系統處理中...") {
            const loaderOverlay = document.getElementById('loader-overlay');
            const loaderText = document.querySelector('#loader-overlay .loader-text');
            const loaderIcon = document.querySelector('#loader-overlay .loader');

            // 顯示容器
            loaderOverlay.style.display = 'flex';
            loaderOverlay.style.opacity = '1';

            // 恢復動畫與透明度
            loaderIcon.style.animation = 'spin 1s linear infinite';
            loaderIcon.style.opacity = '1';
            loaderIcon.style.transition = 'none';  // 清除舊 transition
            loaderIcon.style.transform = 'rotate(0deg)';

            loaderText.textContent = message;
            loaderText.style.opacity = '1';
            loaderText.style.transition = 'none';
        }

        function stopSpinner() {
            //畫面平滑處理
            const loader = document.getElementById('loader-overlay');
            const loaderText = document.querySelector('#loader-overlay .loader-text');
            const loaderIcon = document.querySelector('#loader-overlay .loader');
            // 更新顯示文字
            loaderIcon.style.transition = 'opacity 1s ease';
            loaderIcon.style.opacity = '0';
            setTimeout(function () {

                // 強制 reflow，確保下一步 transition 生效
                void loaderIcon.offsetWidth;
                // 3. 設置最終角度，並添加平滑旋轉 + 淡入
                loaderIcon.style.transition = 'transform 2s ease-out, opacity 1s ease-in';
                loaderIcon.style.transform = 'rotate(360deg)';
                loaderIcon.style.opacity = '1';
                loaderIcon.style.animation = 'none';
                loaderIcon.style.animation = 'slow-stop 2s ease-out forwards';

                loaderText.style.transition = 'transform 2s ease-out, opacity 1s ease-in';
                loaderText.style.opacity = '1';
                loaderText.style.animation = 'none';
                loaderText.style.animation = '2s ease-out forwards';
                loaderText.textContent = '系統處理完成';

            }, 600); // 等待淡出完成
            // 等待過渡結束後再關閉事件源
            setTimeout(function () {
                document.getElementById("loader-overlay").style.display = "none";
            }, 2000); // 等待過渡時間結束

        }
        function hideSpinner() {
            const loader = document.getElementById("loader-overlay");
            if (loader) {
                loader.style.opacity = "0";
                loader.style.transition = "opacity 0.3s ease";
                setTimeout(() => {
                    loader.style.display = "none";
                }, 300);
            }
        }
        /** Loader 處理 End */

        /** LLM 問題處理  */
        let enableThink = false;  // 預設關閉
        function toggleThinkResponse() {
            enableThink = !enableThink;
            const icon = document.getElementById("thinkResponseToggleIcon");
            if (enableThink) {
                icon.classList.remove("fa-toggle-off");
                icon.classList.add("fa-toggle-on");
                icon.title = "關閉推理";
                thinkResponseDiv.innerHTML = "己啟用推理";
            } else {
                icon.classList.remove("fa-toggle-on");
                icon.classList.add("fa-toggle-off");
                icon.title = "開啟推理";
                thinkResponseDiv.innerHTML = "己關閉推理";
            }
        }

        let enableNounAnalysis = false;  // 預設關閉
        function toggleNounAnalysis() {
            enableNounAnalysis = !enableNounAnalysis;
            const icon = document.getElementById("nounAnalysisToggleIcon");
            if (enableNounAnalysis) {
                icon.classList.remove("fa-toggle-off");
                icon.classList.add("fa-toggle-on");
                icon.title = "關閉名詞分析";
                nounAnalysisDiv.innerHTML = "己啟用名詞分析功能";
            } else {
                icon.classList.remove("fa-toggle-on");
                icon.classList.add("fa-toggle-off");
                icon.title = "開啟名詞分析";
                nounAnalysisDiv.innerHTML = "己關閉名詞分析功能";
            }
        }
        async function nounAnalysis() {
            const q = questionInput.value.trim();
            try {
                const res = await fetch("/noun/analysis", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question: q, conv_id: currentConvId })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let title
                let fullRespone = parserTitleStr + "\n";
                nounAnalysisDiv.innerHTML = marked.parse(fullRespone);
                let buffer = "";
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    try {
                        fullRespone += buffer;
                    } catch (e) {
                        // 解析失敗就繼續等
                        continue;
                    }
                    buffer = "";
                    nounAnalysisDiv.innerHTML = marked.parse(fullRespone);
                    nounAnalysisDiv.scrollTop = nounAnalysisDiv.scrollHeight;
                }

            } catch (err) {
                nounAnalysisDiv.innerHTML = `<p style="color:red;">出現錯誤：${err.message}</p>`;
            }
        }

        async function sendQuestion() {
            thinkResponseDiv.innerHTML = "";
            nounAnalysisDiv.innerHTML = "";
            //actualpromptDiv.innerHTML = "";

            const q = questionInput.value.trim();
            if (!q) {
                alert("請建立新對話");
                return;
            }

            if (!currentConvId) {
                const title = q.slice(0, 10);
                const id = `conv-${Date.now()}`;
                conversations[id] = { title: title, messages: [] };
                currentConvId = id;
                updateConversationList();
            }

            hideSpinner();
            setButtonLoading(true); // 啟用 loading 狀態
            if (enableNounAnalysis) {
                await nounAnalysis();
            }

            // 1. 先渲染使用者問題到答案欄
            const userBlock = document.createElement("div");
            userBlock.innerHTML = `<i class="fa-solid fa-user-minus"></i> ${q}`;
            userBlock.style.background = "#e8f0fe";
            userBlock.style.padding = "8px";
            userBlock.style.marginBottom = "10px";
            userBlock.style.textAlign = "right";
            answerDiv.appendChild(userBlock);

            // 2. 預留 answerBlock 並顯示處理中訊息
            const answerBlock = document.createElement("div");
            answerBlock.className = "markdown-body";
            answerBlock.style.background = "#f4f4f4";
            answerBlock.style.padding = "8px";
            answerBlock.style.marginBottom = "20px";
            answerDiv.appendChild(answerBlock);
            if (enableThink) {
                fullAnswer += '<i class="fa-solid fa-robot"> 推理中...</i><BR/>';
            } else {
                fullAnswer += '<i class="fa-solid fa-robot"> 分析中...</i><BR/>';
            }
            answerBlock.innerHTML = marked.parse(fullAnswer);
            // 3. 捲動到底部顯示新問題
            answerDiv.scrollTop = answerDiv.scrollHeight;
            try {
                const keyword = nounAnalysisDiv.textContent.trim().replace(parserTitleStr, "");
                answerDiv.scrollTop = answerDiv.scrollHeight;
                userScrolled = false; // 重置滾動狀態，允許自動滾動
                const res = await fetch("/query", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question: q, keyword: keyword, conv_id: currentConvId, think: enableThink })
                });
                //let fullAnswer = "";
                let thinkResponse = "";
                const reader = res.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let promptExtracted = false;
                let promptValue = "";
                let buffer = "";
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // 嘗試從 buffer 中拆出完整 JSON 物件
                    while (true) {
                        const startIdx = buffer.indexOf('{');
                        if (startIdx === -1) {
                            // buffer 裡沒有 JSON 開頭，等下一筆資料
                            break;
                        }

                        // 尋找完整 JSON 結尾（括號配對）
                        let bracketCount = 0;
                        let endIdx = -1;
                        for (let i = startIdx; i < buffer.length; i++) {
                            if (buffer[i] === '{') bracketCount++;
                            else if (buffer[i] === '}') bracketCount--;
                            if (bracketCount === 0) {
                                endIdx = i;
                                break;
                            }
                        }

                        if (endIdx === -1) {
                            // 尚未收到完整 JSON，繼續等待更多資料
                            break;
                        }

                        const jsonStr = buffer.slice(startIdx, endIdx + 1);
                        try {
                            const data = JSON.parse(jsonStr);

                            if (!promptExtracted && data.prompt !== undefined) {
                                // 提取 prompt
                                promptExtracted = true;
                                actualpromptDiv.innerHTML = `<pre style="white-space:pre-wrap">${data.prompt}</pre>`;
                                // answer 在第一筆可能是空字串，無需動作
                            } else {
                                // 後續串流是 content/thinking
                                if (data.thinking) {
                                    thinkResponse += data.thinking;
                                    thinkResponseDiv.innerHTML = marked.parse(thinkResponse);
                                    thinkResponseDiv.scrollTop = thinkResponseDiv.scrollHeight;
                                }
                                if (data.content) {
                                    fullAnswer += data.content;
                                }
                                answerBlock.innerHTML = marked.parse(fullAnswer);

                                if (!userScrolled) {
                                    answerDiv.scrollTop = answerDiv.scrollHeight;
                                }
                            }

                            // 移除已解析的 JSON
                            buffer = buffer.slice(endIdx + 1).trimStart();
                        } catch (e) {
                            // JSON 解析錯誤，可能不完整，等待更多資料
                            break;
                        }
                    } // end while 拆 JSON
                }
                // 記錄對話
                if (currentConvId) {
                    conversations[currentConvId].messages.push({ q, a: fullAnswer });
                } else {
                    // 若沒有 conversation，創一個
                    const newId = `conv-${Date.now()}`;
                    conversations[newId] = {
                        title: q.slice(0, 10),
                        messages: [{ q, a: fullAnswer }]
                    };
                    currentConvId = newId;
                }
            } catch (err) {
                answerDiv.innerHTML = `<p style="color:red;">出現錯誤：${err.message}</p>`;
            } finally {
                await loadConversations();
                await switchConversation(currentConvId);
                setButtonLoading(false); // 關閉 loading 狀態
            }
        }


        /** 參數處理 END */
        /** 事件綁定 */
        window.addEventListener("load", () => {
            loadConversations();
            sendBtn.addEventListener("click", sendQuestion);
            // 監聽答案區域的滾動事件
            answerDiv.addEventListener('scroll', () => {
                const isNearBottom = answerDiv.scrollHeight - answerDiv.scrollTop - answerDiv.clientHeight < 10;
                if (!isNearBottom) {
                    userScrolled = true;
                } else {
                    userScrolled = false;
                }
            });

            // 載入用戶資訊
            loadUserInfo();

            // 綁定個人功能按鈕事件
            //document.getElementById('userMenuBtn').addEventListener('mouseenter', openUserMenu);
        });

        // 載入用戶資訊
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/current-user');
                if (response.ok) {
                    const userData = await response.json();
                    const username = userData.username;
                    const initial = username.charAt(0).toUpperCase();
                    document.getElementById('userInitial').textContent = initial;
                    document.getElementById('userMenuUsername').textContent = username;
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // 個人功能抽屜相關函數
        function openUserMenu() {
            document.getElementById('userMenuDrawer').classList.add('open');
        }

        function closeUserMenu() {
            document.getElementById('userMenuDrawer').classList.remove('open');
        }

        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'block';
            // 清空表單
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        async function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            // 驗證輸入
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                alert('請填寫所有欄位！');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                alert('新密碼與確認密碼不一致！');
                return;
            }

            if (newPassword.length < 6) {
                alert('新密碼長度至少需要6個字符！');
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });

                if (response.ok) {
                    alert('密碼變更成功！');
                    closeChangePasswordModal();
                } else {
                    const errorData = await response.json();
                    alert(`密碼變更失敗：${errorData.detail || '未知錯誤'}`);
                }
            } catch (error) {
                alert(`密碼變更失敗：${error.message}`);
            }
        }


        // 新增：按鈕 loading 狀態切換 function
        function setButtonLoading(isLoading) {
            const btn = document.getElementById("sendBtn");
            if (!btn) return;
            if (isLoading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = '<span class="btn-loader"></span>';
                btn.classList.add("btn-loading");
                btn.disabled = true;
            } else {
                if (btn.dataset.originalText) {
                    btn.innerHTML = btn.dataset.originalText;
                    delete btn.dataset.originalText;
                }
                btn.classList.remove("btn-loading");
                btn.innerHTML = '送出問題';
                btn.disabled = false;
            }
        }

        function logout() {
            const confirmed = window.confirm("確定要登出嗎？");
            if (confirmed) {
                fetch('/api/logout', {
                    method: 'GET',
                    credentials: 'same-origin'
                }).then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                });
            }
        }

        // 滑鼠離開抽屜外部關閉抽屜
        document.addEventListener('DOMContentLoaded', function () {
            var userMenuDrawer = document.getElementById('userMenuDrawer');
            if (userMenuDrawer) {
                userMenuDrawer.addEventListener('mouseleave', function () {
                    if (typeof closeUserMenu === 'function') closeUserMenu();
                });
            }
        });
        
        // 控制推理功能是否渲染
        async function checkThinkFeature() {
            try {
                const res = await fetch('/isEnableThink');
                const isEnabled = await res.json();

                if (!isEnabled) {
                    const section = document.getElementById("thinkToggleSection");
                    if (section) section.style.display = "none";
                }
            } catch (error) {
                console.error("讀取推理開關狀態失敗：", error);
            }
        }
        window.addEventListener("DOMContentLoaded", checkThinkFeature);
    </script>
</body>

</html>